<section class="grid gap-6">
  <h1 class="text-2xl font-semibold mb-2">Dashboard</h1>

  <!-- Ãœstte iki bÃ¼yÃ¼k bÃ¶lÃ¼m -->
  <div class="grid md:grid-cols-1 gap-4">
    <a href="#support-ticket" class="block rounded-xl border border-slate-800 bg-slate-900 p-8 hover:border-indigo-500 hover:bg-slate-800 transition">
      <h2 class="text-xl font-semibold mb-2">Support Ticket System</h2>
      <p class="text-slate-400">Ticket ayarlarÄ±nÄ± ve panelleri dÃ¼zenleyin.</p>
    </a>
    <a href="#kick-alert" class="block rounded-xl border border-slate-800 bg-slate-900 p-8 hover:border-emerald-500 hover:bg-slate-800 transition">
      <h2 class="text-xl font-semibold mb-2">Kick Activity Alert</h2>
      <p class="text-slate-400">Kick yayÄ±ncÄ±larÄ± ekleyin ve DM uyarÄ±sÄ±nÄ± ayarlayÄ±n.</p>
    </a>
  </div>

  <div class="grid md:grid-cols-2 gap-6">
    <!-- Status -->
    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
      <h2 class="font-semibold mb-3">Bot Status</h2>
      <ul class="text-sm space-y-1">
        <li><b>Bot:</b> <%= ready ? 'ðŸŸ¢ Online' : 'ðŸ”´ Offline' %></li>
        <li><b>Logged in as:</b> <%= botTag || 'n/a' %></li>
        <li><b>Guild ID:</b> <%= guildId %></li>
      </ul>
    </div>

    <!-- Ticket settings -->
    <div id="support-ticket" class="bg-slate-900 border border-slate-800 rounded-xl p-4">
      <h2 class="font-semibold mb-3">Ticket Settings</h2>
      <form method="POST" action="/dashboard/save-config" class="grid gap-3">
        <label class="grid gap-1">
          <span>Support Category</span>
          <select name="supportCategoryId" class="px-3 py-2 rounded bg-slate-800 border border-slate-700">
            <option value="">-- Select a category --</option>
            <% (guildData.categories || []).forEach(c => { %>
              <option value="<%= c.id %>" <%= String(cfg.supportCategoryId)===String(c.id) ? 'selected' : '' %>><%= c.name %></option>
            <% }) %>
          </select>
        </label>

        <div class="grid gap-1">
          <span>Staff Roles (can claim/close)</span>
          <div id="roleChips" class="flex flex-wrap gap-2">
            <% const selected = new Set(cfg.allowedRoleIds || []); %>
            <% (guildData.roles || []).forEach(r => { %>
              <button type="button" data-role="<%= r.id %>" class="px-3 py-1 rounded-full border <%= selected.has(r.id) ? 'bg-emerald-600 border-emerald-500' : 'bg-slate-800 border-slate-700' %>">
                <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color:#<%= (r.color || 0).toString(16).padStart(6,'0') %>"></span>
                <%= r.name %>
              </button>
            <% }) %>
          </div>
          <input id="rolesInput" name="allowedRoleIds" type="hidden" value="<%= (cfg.allowedRoleIds || []).join(',') %>">
        </div>

        <button class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500 w-fit">Save</button>
      </form>
    </div>
  </div>

  <!-- Panel 1 -->
  <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
    <h2 class="font-semibold mb-3">Panel 1 â€” Ticket Panel</h2>
    <%- include('partials/panel-editor', { which: 1, panel: panel1 }) %>
  </div>

  <!-- Panel 2 -->
  <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
    <h2 class="font-semibold mb-3">Panel 2 â€” Ticket Panel</h2>
    <%- include('partials/panel-editor', { which: 2, panel: panel2 }) %>
  </div>

  <!-- Kick Activity Alert -->
  <div id="kick-alert" class="bg-slate-900 border border-slate-800 rounded-xl p-4">
    <h2 class="font-semibold mb-3">Kick Activity Alert</h2>

    <form id="kickForm" method="POST" action="/dashboard/kick/save" class="grid gap-4">
      <div class="grid md:grid-cols-2 gap-3">
        <label class="grid gap-1">
          <span>Allowed Voice Channel IDs (comma-separated)</span>
          <input name="voice_allowed_ids" value="<%= (cfg.kick?.allowedVoiceIds || []).join(',') %>" class="px-3 py-2 rounded bg-slate-800 border border-slate-700"/>
          <span class="text-xs text-slate-400">BoÅŸ bÄ±rakÄ±lÄ±rsa herhangi bir ses kanalÄ± kabul edilir.</span>
        </label>

        <label class="grid gap-1">
          <span>Global DM Message</span>
          <textarea name="kick_message" rows="4" class="px-3 py-2 rounded bg-slate-800 border border-slate-700"><%= cfg.kick?.message || '' %></textarea>
          <span class="text-xs text-slate-400">DeÄŸiÅŸkenler: {user} {login} {url} {title} {game}</span>
        </label>
      </div>

      <div class="flex items-center justify-between">
        <h3 class="font-medium">Streamers (Kick)</h3>
        <button type="button" id="kickAdd" class="px-3 py-1 rounded bg-indigo-600 hover:bg-indigo-500">Add row</button>
      </div>

      <input type="hidden" id="kickCount" name="kick_count" value="<%= (streamers||[]).length %>">
      <div id="kickList" class="grid gap-2">
        <% (streamers || []).forEach((s, i) => { %>
          <div class="grid md:grid-cols-5 gap-2 items-center border border-slate-800 rounded p-2">
            <input name="kick_<%= i %>_login" value="<%= s.login || '' %>" placeholder="Kick username" class="px-3 py-2 rounded bg-slate-800 border border-slate-700"/>
            <input name="kick_<%= i %>_uid" value="<%= s.discordUserId || '' %>" placeholder="Discord User ID" class="px-3 py-2 rounded bg-slate-800 border border-slate-700"/>
            <select name="kick_<%= i %>_chan" class="px-3 py-2 rounded bg-slate-800 border border-slate-700">
              <option value="">â€” fallback channel (optional) â€”</option>
              <% (guildData.text || []).forEach(t => { %>
                <option value="<%= t.id %>" <%= String(s.announceChannelId||'')===String(t.id)?'selected':'' %>><%= t.name %></option>
              <% }) %>
            </select>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="kick_<%= i %>_enabled" <%= s.enabled ? 'checked' : '' %> />
              <span>Enabled</span>
            </label>
            <button type="button" class="kickRemove px-3 py-1 rounded bg-red-600 hover:bg-red-500">Remove</button>
          </div>
        <% }) %>
      </div>

      <button class="mt-2 px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500 w-fit">Save Kick Settings</button>
    </form>
  </div>
</section>

<script>
  // role chips
  const roleChips = document.getElementById('roleChips');
  const rolesInput = document.getElementById('rolesInput');
  roleChips?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-role]');
    if (!btn) return;
    btn.classList.toggle('bg-emerald-600');
    btn.classList.toggle('border-emerald-500');
    btn.classList.toggle('bg-slate-800');
    btn.classList.toggle('border-slate-700');
    const id = btn.getAttribute('data-role');
    const set = new Set((rolesInput.value?rolesInput.value.split(','):[]).filter(Boolean));
    set.has(id) ? set.delete(id) : set.add(id);
    rolesInput.value = Array.from(set).join(',');
  });

  // Kick dynamic rows
  const kickList  = document.getElementById('kickList');
  const kickAdd   = document.getElementById('kickAdd');
  const kickCount = document.getElementById('kickCount');

  function addRow(){
    const i = kickList.querySelectorAll('.grid.md\\:grid-cols-5').length;
    const row = document.createElement('div');
    row.className = 'grid md:grid-cols-5 gap-2 items-center border border-slate-800 rounded p-2';
    row.innerHTML = `
      <input name="kick_${i}_login" placeholder="Kick username" class="px-3 py-2 rounded bg-slate-800 border border-slate-700"/>
      <input name="kick_${i}_uid" placeholder="Discord User ID" class="px-3 py-2 rounded bg-slate-800 border border-slate-700"/>
      <select name="kick_${i}_chan" class="px-3 py-2 rounded bg-slate-800 border border-slate-700">
        <option value="">â€” fallback channel (optional) â€”</option>
        <% (guildData.text || []).forEach(t => { %>
          <option value="<%= t.id %>"><%= t.name %></option>
        <% }) %>
      </select>
      <label class="inline-flex items-center gap-2"><input type="checkbox" name="kick_${i}_enabled" checked/> <span>Enabled</span></label>
      <button type="button" class="kickRemove px-3 py-1 rounded bg-red-600 hover:bg-red-500">Remove</button>
    `;
    kickList.appendChild(row);
    kickCount.value = kickList.querySelectorAll('.grid.md\\:grid-cols-5').length;
  }
  kickAdd?.addEventListener('click', addRow);

  kickList?.addEventListener('click', (e)=>{
    const btn = e.target.closest('.kickRemove');
    if (!btn) return;
    const box = btn.closest('.grid.md\\:grid-cols-5');
    box.remove();
    const rows = kickList.querySelectorAll('.grid.md\\:grid-cols-5');
    rows.forEach((r,idx)=>{
      r.querySelectorAll('input,select').forEach(el=>{
        el.name = el.name.replace(/kick_\d+_/g, `kick_${idx}_`);
      });
    });
    kickCount.value = rows.length;
  });
</script>
